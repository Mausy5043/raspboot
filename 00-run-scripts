#! /bin/bash

logfile=/tmp/gitbin.err
CLNT=$(hostname)

#if [ ! -d /tmp/gitbin ]; then
#  mkdir /tmp/gitbin
#fi

# Create an empty logfile
echo "" > $logfile

# Change PWD to the binaries directory
pushd /home/pi/gitbin 2>$logfile 1>&2

# Check for new/updated scripts
./01-update-scripts.sh | tee -a $logfile | logger -p local7.info -t 01-update-scripts

# Execute the common scripts in parallel
./11-get-temp.py & ./12-get-load.py & ./13-get-nettraffic.py & ./14-get-memory.py & ./31-xml-status.sh & wait 2>$logfile 1>&2

# Execute client-specific scripts
if [ $CLNT == "rbups" ]; then
  ./16-get-upsstate.py 2>$logfile 1>&2
fi

# Upload the data
./99-upload-data.sh 2>$logfile 1>&2

# Change PWD back to original
popd 2>$logfile 1>&2
